# Go安全规范精简版

## 1. 通用安全规范

### 1.1 内存管理

**【必须】切片操作前验证长度**
- 访问slice元素前必须检查len()，防止越界panic

**【必须】指针使用前判空**
- 操作指针前必须判断是否为nil，特别是Unmarshal后的结构体指针

**【必须】整数运算安全**
- 防止整数溢出/反转/截断/符号错误
- 作为数组索引、长度、边界时必须严格校验范围

**【必须】make分配前验证长度**
- 外部可控的长度参数必须限制上限（如64MB），防止panic

**【必须】禁止SetFinalizer与指针循环引用同时使用**
- 会导致Finalizer无法调用，造成内存泄漏

**【必须】禁止重复关闭channel**
- 使用defer close()确保只关闭一次

**【必须】确保协程能退出**
- 所有goroutine必须有退出条件，防止泄漏

**【推荐】避免使用unsafe包**
- 绕过内存安全，可能导致内存破坏

**【推荐】避免slice作为函数入参**
- slice传参会共享底层数组，修改影响原数据，建议传数组或拷贝

### 1.2 文件操作

**【必须】路径穿越检查**
- 外部传入的文件路径必须检查是否包含`..`等穿越字符
- 使用filepath.Clean()规范化路径并验证

**【必须】文件权限控制**
- 敏感文件权限设置为0640或更严格

### 1.3 系统接口

**【必须】命令执行防注入**
- 使用exec.Command时，外部参数必须白名单校验
- 使用shellescape库过滤特殊字符
- 禁止直接拼接命令字符串到sh -c

### 1.4 通信安全

**【必须】使用TLS加密通信**
- 生产环境必须使用TLS1.3，禁止明文传输

**【推荐】启用TLS证书验证**
- 禁止设置`InsecureSkipVerify: true`

### 1.5 敏感数据保护

**【必须】禁止硬编码敏感信息**
- 禁止硬编码AK/SK、数据库密码、私钥、IP、员工信息
- 使用配置系统或KMS管理

**【必须】敏感数据输出脱敏**
- 日志禁止输出密码（明文/密文）、密钥
- 身份证显示首尾，手机号隐藏中间6位，银行卡仅显示后4位

**【必须】敏感数据加密存储**
- 使用SHA2、RSA等算法加密
- 独立存储层并启用访问控制

**【必须】异常处理安全**
- 使用defer+recover处理panic，禁止错误信息输出到前端
- 生产环境禁止开启debug模式

### 1.6 加密解密

**【必须】禁止硬编码密钥**
- 通过配置或算法变换管理密钥

**【必须】密钥安全存储**
- 敏感数据加密时通过非对称算法协商密钥

**【推荐】禁用弱加密算法**
- 禁用DES、MD5、SHA1、RC4等

### 1.7 正则表达式

**【推荐】使用regexp包**
- 保证线性时间性能，防止ReDoS攻击
- 注意：不支持回溯引用和环视断言

## 2. 后台服务安全

### 2.1 输入校验

**【必须】白名单校验所有外部输入**
- 使用validator库校验数据类型、长度、范围、格式
- 无法白名单的使用html.EscapeString或bluemonday过滤`<>&'"`
- tRPC-go必须启用validation拦截器，所有String字段必须校验

### 2.2 SQL操作

**【必须】使用预编译语句**
- 使用database/sql的Prepare或GORM等ORM
- 禁止拼接SQL，使用?占位符绑定参数
- order by和表名参数需额外白名单校验

### 2.3 网络请求

**【必须】SSRF防护**
- 外部可控URL必须严格校验：
  1. 仅允许HTTP/HTTPS协议
  2. 解析HOST获取IP
  3. 禁止访问内网IP段（10/8, 172.16/12, 192.168/16等）
  4. 跳转后重新校验
- 推荐使用scurl安全API
- COS地址白名单需限制到具体appid

**【必须】XXE防护**
- 使用官方encoding/xml库（不支持外部实体）

### 2.4 服务器端渲染

**【必须】模板注入防护**
- 禁止外部输入拼接到模板
- 使用text/template或html/template自动编码
- 外部参数必须白名单校验后才能使用

### 2.5 Web跨域

**【必须】CORS严格限制来源**
- AllowedOrigins设置具体域名，禁用通配符*
- 敏感操作必须设置AllowCredentials

### 2.6 响应输出

**【必须】设置正确Content-Type**
- 响应头与实际内容类型一致

**【必须】添加安全响应头**
- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY/SAMEORIGIN/ALLOW-FROM`

**【必须】响应头注入防护**
- 外部输入拼接到响应头前过滤`\r\n`

**【必须】XSS防护**
- 输出到HTML前使用html.EscapeString或template自动编码

### 2.7 会话管理

**【必须】安全维护session**
- 登录时重新生成session
- 退出时清理session
- 设置HttpOnly、Secure、过期时间

**【必须】CSRF防护**
- 敏感操作校验Referer或使用csrf_token
- tRPC-Go使用bkn/gtk拦截器

### 2.8 访问控制

**【必须】默认鉴权**
- 白名单方式放开公开资源
- 最小权限原则设置角色权限
- 用户数据读写必须验证身份和权限，防止越权
- 外网用QQ/微信登录，内网用TOF，其他需二次验证
- tRPC-Go使用ptlogin/wxlogin/qqconnect拦截器

### 2.9 并发安全

**【必须】闭包中不直接使用循环变量**
- 通过参数传递或局部变量避免数据竞争

**【必须】禁止并发写map**
- 使用sync.Mutex或sync.RWMutex保护
- 或使用sync.Map

**【必须】敏感操作并发保护**
- 使用sync包的锁或atomic包的原子操作

## 3. 依赖管理

**【推荐】依赖库安全检测**
- 使用horus系统检测恶意包
- 或仅从腾讯软件源下载：https://mirrors.tencent.com/go/