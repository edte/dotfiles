# C/C++安全规范（精简版）

## 1. C/C++使用错误

### 1.1 字符串操作
- **禁止**直接使用无长度限制函数：strcpy/strcat/sprintf/wcscpy/mbscpy等
- **必须**使用_s版本或n版本（snprintf/vsnprintf），并严格限制长度
- **注意**：strncpy/_snprintf不保证\0结尾，需手动添加
- **建议**：C++优先使用string/vector代替原始指针

### 1.2 进程创建
- **必须**为路径加双引号，防止空格劫持：`"\"D:\\program files\\app.exe\""`
- **必须**检查用户输入，防止命令注入（如`&&`、`|`等特殊字符）

### 1.3 栈内存分配
- **禁止**在循环中使用_alloca或可变长度数组（VLA）
- **原因**：可能导致栈溢出或内存损坏
- **建议**：改用堆内存（malloc/new）或C++ string/vector

### 1.4 printf系列
- **必须**确保格式符与参数类型对应
- **禁止**泄露指针值（%p）到外部，会破坏ASLR
- **禁止**用户可控字符串作为format参数：`snprintf(buf, size, user_input)` ❌
- **正确**：`snprintf(buf, size, "%s", user_input)` ✓

### 1.5 内存管理
- **必须**：数组用delete[]，对象用delete
- **建议**：C++使用智能指针（unique_ptr/shared_ptr）

### 1.6 类型转换
- **注意**隐式符号转换：unsigned char/short运算时可能转为signed int
- **注意**八进制陷阱：`020`是八进制（16），不是十进制20
- **必须**检查有符号/无符号混合运算

## 2. 编程习惯

### 2.1 控制流
- **必须**：switch必须有default分支
- **必须**：函数每个分支都有返回值
- **禁止**：if中赋值（`if(a=0)`应为`if(a==0)`）
- **检查**：重复代码通常代表错误
- **检查**：永远为真/假的判断（如`if(a==a)`）

### 2.2 变量初始化
- **必须**：使用前初始化栈变量
- **必须**：检查malloc/mmap等返回值
- **建议**：刚分配的内存使用前清零

### 2.3 信息泄露
- **禁止**：Debug信息输出内存地址、敏感数据
- **禁止**：客户端硬编码对称加密密钥（AES/SM1等）
- **建议**：密钥从服务器获取或使用HKDF衍生

### 2.4 函数设计
- **禁止**：返回栈变量地址
- **必须**：声明与实现参数顺序一致
- **必须**：有逻辑关联的数组长度一致

## 3. 多线程

### 3.1 线程安全
- **必须**：多线程共享变量使用原子操作或加锁
- **推荐**：C11用atomic，C++11用std::atomic

### 3.2 信号处理
- **注意**：signal handler中避免不可重入函数（malloc/free/syslog等）
- **注意**：TOCTOU竞争条件（检查与使用之间状态变化）

## 4. 加密安全

### 4.1 密码存储
- **必须**：密码用Argon2/scrypt/bcrypt/pbkdf2哈希，禁止明文
- **必须**：敏感数据传输加密（HTTPS）、存储加密（SQLCipher）

### 4.2 内存清理
- **必须**：密码等敏感数据使用后清零：`OPENSSL_cleanse()`

### 4.3 随机数
- **必须**：rand()使用前用srand()初始化
- **禁止**：加密场景使用rand()等弱PRNG
- **必须**：加密用CSPRNG：
  - OpenSSL: `RAND_bytes()`
  - libsodium: `randombytes_buf()`
  - Linux: `getrandom()`或/dev/urandom
  - Windows: `BCryptGenRandom()`

## 5. 文件操作

### 5.1 路径安全
- **必须**：检查文件名中的`../`路径穿越字符
- **必须**：使用白名单限制文件后缀
- **必须**：固定文件操作路径，或对用户输入做hash/白名单过滤

### 5.2 进程启动
- **必须**：使用绝对路径，避免DLL/EXE劫持
- **建议**：调用SetDllDirectory("")移除当前目录

### 5.3 权限控制
- **禁止**：创建777权限文件
- **必须**：根据敏感级别设置最小权限

## 6. 内存操作

### 6.1 越界防护
- **必须**：防止数组越界读写（向前/向后）
- **必须**：校验用户可控的索引值
- **必须**：防止任意地址写

### 6.2 整数安全
- **必须**：防止整数溢出（尤其内存操作前）
- **必须**：防止Off-By-One错误
- **必须**：比较时同时检查最大/最小值
- **必须**：防止有符号/无符号错误转换
- **必须**：检查除零异常

## 7. 指针操作

### 7.1 指针检查
- **必须**：使用前检查空指针
- **必须**：free/delete后置NULL
- **建议**：避免在指针上用sizeof（除非测指针长度）
- **禁止**：数组与0比较（`if(arr>0)`永远为真）
- **禁止**：硬编码指针地址（特殊硬件场景除外）

### 7.2 类型安全
- **必须**：防止类型混淆（type confusion）
- **必须**：操作前验证对象真实类型
- **必须**：智能指针避免与原始指针混用，防止UAF

## 8. 后台开发规范

### 8.1 输入验证
- **必须**：校验外部输入的长度、范围、类型、格式

### 8.2 文件上传
- **必须**：白名单限制后缀
- **必须**：重命名为随机字符串或编码后保存
- **必须**：敏感文件（身份证/银行卡）加密、鉴权、水印

### 8.3 网络请求
- **必须**：限定协议、域名、路径范围
- **必须**：禁止访问内网地址段（10.0.0.0/8等）
- **推荐**：使用HTTPS

### 8.4 数据输出
- **禁止**：存储/展示口令、密保答案、CVV码
- **必须**：脱敏展示：身份证显示首尾、手机号隐藏中6位、银行卡仅显示后4位

### 8.5 响应安全
- **必须**：设置正确Content-Type
- **必须**：添加响应头：
  - `X-Content-Type-Options: nosniff`
  - `X-Frame-Options: SAMEORIGIN/DENY`
- **必须**：外部输入输出前编码（HTML/JS/CSS/URL编码）
- **禁止**：响应包含物理路径、源码、调试日志
- **推荐**：部署CSP策略

### 8.6 跨域安全
- **必须**：JSONP的callback限制为`[a-zA-Z0-9_-]+`
- **必须**：CORS严格校验Origin（全等或严格正则）

### 8.7 SQL操作
- **必须**：使用预编译+绑定变量（mysql_stmt_prepare）
- **必须**：表名/列名用白名单校验

### 8.8 URL跳转
- **必须**：白名单限制协议（HTTP/HTTPS）和域名
- **建议**：使用ID/token映射，避免直接传URL

## 9. 配置管理

### 9.1 敏感配置
- **禁止**：硬编码AK/SK、IP、数据库密码
- **必须**：使用配置系统或KMS密钥管理

---

## 关联漏洞级别说明
- **高风险**：代码执行、权限提升、内存破坏、缓冲区溢出、敏感信息泄露
- **中风险**：信息泄露、逻辑漏洞、内存泄漏
- **低风险**：拒绝服务

## 编译建议
- 开启警告：GCC使用`-Wall -Wextra`
- 关键警告设为错误：`-Werror=return-type -Werror=uninitialized`
- 使用现代C++特性（C++11及以上）
- 优先使用STL容器和智能指针
