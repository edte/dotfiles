# Java安全规范精简版

## 一、输入验证与数据净化

### 1.1 注入防护
- **【必须】SQL注入防护**:使用预编译语句(PreparedStatement)和参数绑定(Mybatis用#{})
- **【必须】命令注入防护**:禁止外部输入拼接到Runtime.exec()、ProcessBuilder,避免创建shell
- **【必须】路径穿越防护**:使用getCanonicalPath()验证路径,检查"..",禁止全路径可控
- **【必须】XXE防护**:XML解析器禁用DTD和外部实体(setFeature关闭doctype-decl)
- **【必须】表达式注入防护**:禁止外部输入拼接到EL表达式、模板引擎
- **【必须】正则注入防护**:净化传递给正则表达式的非受信数据

### 1.2 数据验证
- **【必须】验证前规范化**:Unicode编码规范化,路径标准化
- **【必须】白名单过滤**:表名/列名/order by等无法预编译场景用白名单
- **【必须】类型验证**:验证外部数据的类型、长度、格式,防止溢出
- **【必须】编码一致性**:文件/网络IO两端使用兼容编码,避免数据丢失

### 1.3 特殊场景
- **【必须】日志注入防护**:记录日志前净化用户输入
- **【必须】格式字符串防护**:禁止用户输入作为格式字符串
- **【必须】Zip炸弹防护**:ZipEntry.getSize()检查解压前文件大小
- **【建议】Locale处理**:大小写转换指定Locale,如toUpperCase(Locale.ENGLISH)

## 二、文件操作安全

### 2.1 路径安全
- **【必须】禁止全路径可控**:文件路径不能完全由客户端传入
- **【必须】防止路径穿越**:检查".."或用getCanonicalPath().startsWith()验证
- **【建议】避免路径拼接**:文件名用UUID随机化,目录后台写死

### 2.2 文件类型控制
- **【建议】类型白名单**:Web目录下文件必须限制类型(禁止jsp/class/jar/war等)
- **【建议】非Web目录**:文件优先保存到文件服务器映射目录

### 2.3 文件资源管理
- **【必须】关闭资源**:使用try-with-resources自动关闭
- **【必须】临时文件清理**:程序终止前删除临时文件
- **【必须】权限控制**:创建文件时设置合适的访问权限

## 三、网络与传输安全

### 3.1 SSRF防护
- **【必须】URL白名单**:访问外部URL前验证域名白名单
- **【必须】内网IP过滤**:DNS解析后过滤内网IP段
- **【必须】禁用跳转**:setRedirectsEnabled(false)

### 3.2 SSL/TLS安全
- **【必须】证书验证**:自定义X509TrustManager必须实现checkServerTrusted
- **【必须】域名验证**:自定义HostnameVerifier必须实现verify校验
- **【必须】严格模式**:使用STRICT_HOSTNAME_VERIFIER,禁用ALLOW_ALL
- **【建议】使用SSLSocket**:敏感数据传输用SSLSocket而非Socket

### 3.3 Android WebView安全
- **【必须】API18以下禁用addJavaScriptInterface**
- **【建议】禁用JS**:setJavaScriptEnabled(false)
- **【建议】禁用File协议**:setAllowFileAccess(false)
- **【建议】禁止保存密码**:setSavePassword(false)
- **【必须】SSL错误处理**:onReceivedSslError不能直接proceed

## 四、响应输出安全

### 4.1 XSS防护
- **【必须】输出编码**:根据上下文编码(HTML/JS/CSS/URL),可用ESAPI库
- **【必须】Content-Type正确**:响应类型必须正确,非HTML不设text/html
- **【建议】安全响应头**:X-Content-Type-Options:nosniff, HttpOnly, X-Frame-Options

### 4.2 跳转与JSONP
- **【必须】跳转白名单**:302跳转前验证域名白名单,用URL.getHost()解析
- **【必须】JSONP限制**:callback仅允许[a-zA-Z0-9_-]+,不传输敏感信息
- **【必须】响应头注入防护**:过滤\r\n换行符

### 4.3 CORS与异常
- **【必须】CORS严格过滤**:Access-Control-Allow-Origin严格验证Origin
- **【必须】屏蔽异常栈**:不返回敏感错误信息给客户端

## 五、会话与权限

### 5.1 会话管理
- **【必须】凭证传输**:非一次性凭证禁止URL传输
- **【必须】会话验证**:禁止未校验数据直接赋值会话
- **【必须】登录态隔离**:敏感业务采用登录态隔离

### 5.2 CSRF防护
- **【必须】Token验证**:敏感操作使用CSRF Token(随机、不可预测、非Cookie传输)
- **【必须】Referer校验**:验证Referer同源,拒绝空Referer

### 5.3 权限控制
- **【必须】身份验证**:从session等可信结构获取身份,禁止从参数获取
- **【必须】操作权限**:校验用户是否有操作权限
- **【必须】数据权限**:校验用户是否有访问该数据的权限

### 5.4 数据保护
- **【必须】信息最小化**:仅返回业务必需的用户信息
- **【必须】敏感信息脱敏**:身份证/手机/银行卡等脱敏展示

## 六、加密与序列化

### 6.1 加密算法
- **【建议】对称加密**:AES(≥128位),禁用DES;CBC模式IV随机,推荐GCM模式
- **【建议】非对称加密**:RSA(≥2048位)
- **【建议】哈希算法**:SHA-2及以上,签名用HMAC,盐值不置于开头
- **【建议】密码存储**:随机盐+多轮哈希
- **【建议】随机数**:用SecureRandom而非Random
- **【必须】禁止硬编码**:敏感信息不硬编码

### 6.2 序列化安全
- **【必须】版本兼容**:显式指定serialVersionUID
- **【必须】签名加密**:敏感对象跨信任边界需签名加密
- **【必须】防御性复制**:readObject()中对可变组件防御性复制
- **【必须】禁止序列化内部类**
- **【必须】YAML安全**:SnakeYAML用SafeConstructor或Constructor(Class)

### 6.3 Android异常处理
- **【必须】Intent异常捕获**:序列化/空指针/类型转换异常必须try-catch
- **【必须】禁止日志输出**:release版本禁止logcat输出

## 七、并发与线程安全

### 7.1 可见性与原子性
- **【必须】共享变量**:声明volatile或正确同步
- **【必须】原子操作**:组合操作(++/+=)保证原子性
- **【必须】64位数值**:读写long/double保证原子性

### 7.2 锁机制
- **【必须】私有final锁**:与非受信代码交互用private final锁对象
- **【必须】避免锁重用对象**:不用Boolean/Integer/getClass()/集合视图作锁
- **【必须】锁顺序一致**:相同顺序请求释放锁,异常时释放锁
- **【必须】避免持锁阻塞**:持锁时不执行阻塞操作
- **【必须】双重检查**:延迟初始化用正确的双重检查

### 7.3 线程API
- **【必须】调用start()**:不直接调用Thread.run()
- **【必须】notifyAll()**:通知所有等待线程而非单一线程
- **【必须】循环wait()**:在while循环中调用wait()/await()
- **【必须】可中断任务**:线程池任务必须可中断
- **【必须】异常处理**:覆写afterExecute()或用Future.get()处理异常
- **【必须】避免死锁**:有限线程池不执行相互依赖任务

### 7.4 对象发布
- **【必须】防止this泄漏**:构造函数中不调用可覆写方法/不返回this/不传this给外部
- **【必须】完整初始化**:不发布部分初始化对象

## 八、面向对象安全

### 8.1 类设计
- **【必须】私有成员**:数据成员私有,提供封装器方法
- **【必须】防御性复制**:可变输入/内部组件创建防御性复制(深复制)
- **【必须】禁止敏感类复制**:不实现Cloneable,不提供复制构造
- **【必须】final变量**:增强for循环变量声明为final
- **【必须】避免循环初始化**:static final字段可能未完全初始化

### 8.2 方法规约
- **【必须】不用断言验证参数**:用异常而非assert
- **【必须】安全方法private/final**:安全检测方法声明private或final
- **【必须】构造函数安全**:不调用可覆写方法,尽量不抛异常
- **【必须】equals与hashCode**:定义equals必须定义hashCode
- **【必须】避免析构函数**:不依赖finalize()

### 8.3 异常处理
- **【必须】不消除异常**:不忽略可检查异常
- **【必须】不泄漏敏感信息**:异常不包含敏感信息
- **【必须】finally安全**:不在finally中return/break/continue/throw
- **【必须】明确异常类型**:不抛RuntimeException/Exception/Throwable

### 8.4 数值运算
- **【必须】整数溢出**:检测并向上转型
- **【必须】除零检查**:除法/模运算检查除数非零
- **【必须】浮点数限制**:不用float/double精确计算,不用作循环计数器
- **【必须】BigDecimal**:不从浮点数构造,避免精度损失
- **【必须】类型转换**:慎重处理向上/向下转型

## 九、平台与反射

### 9.1 安全管理
- **【必须】特权代码块**:不泄漏敏感信息,不使用非受信变量
- **【必须】安全检查**:基于受信源,检查前防御性深复制
- **【必须】反射限制**:不用反射增加可访问性
- **【必须】类加载器**:自定义加载器调用基类getPermissions()

### 9.2 Android配置
- **【必须】PermissionGroup**:不设为空
- **【必须】protectionLevel**:设为signature或signatureOrSystem
- **【建议】allowBackup**:设为false
- **【必须】debuggable**:release版本设为false

## 十、其他安全要点

- **【必须】集合遍历**:遍历时不修改集合,用同步集合或CopyOnWriteArrayList
- **【必须】单例安全**:构造私有、线程可见、不可序列化/克隆
- **【必须】IO操作**:不操作共享目录,read()返回值用int,不将二进制当字符读
- **【建议】加锁操作**:次数限制的操作(抽奖)需加锁防止竞态条件